<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kingdom 3782 - DKP</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>üèÜ DKP - CH25</h1>

        <!-- =========== DKP CALCULATOR =========== -->
<div class="calculator">
    <h2>üßÆ DKP Calculator</h2>
    <p class="calculator-note">Enter your in-game name to see how much KP you need for 100% DKP</p>
    
    <div class="calculator-row">
        <div class="calculator-input-group">
            <label for="calc-name">Player Name:</label>
            <input type="text" id="calc-name" placeholder="Enter your nickname..." oninput="searchPlayerForCalc()">
        </div>
        <button class="calculator-btn" onclick="searchPlayerForCalc()">üîç Calculate</button>
    </div>
    
    <div id="calculator-results" class="calculator-results" style="display: none;">
        <div class="results-grid">
            <div class="result-item">
                <span class="result-label">Current Power:</span>
                <span class="result-value" id="calc-power">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">Current DKP:</span>
                <span class="result-value" id="calc-dkp">-</span>
            </div>
            <div class="result-item highlight">
                <span class="result-label">T4/T5 KP needed for 100%:</span>
                <span class="result-value" id="calc-kp-needed">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">T4 units to kill:</span>
                <span class="result-value" id="calc-t4-kills">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">T5 units to kill:</span>
                <span class="result-value" id="calc-t5-kills">-</span>
            </div>
        </div>
    </div>
    
    <div id="calculator-not-found" class="calculator-not-found" style="display: none;">
        ‚ùå Player not found. Check the spelling or try a different name.
    </div>
</div>

        <div class="stats">
            <div>Last Updated: <span id="last-update">-</span></div>
            <div>Total Players: <span id="player-count">0</span></div>
            <div>Showing: <span id="showing-count">0</span> players</div>
            <div>Last Scan: <span id="last-scan">10.02.2026</span></div>
        </div>

        <div class="controls">
            <button class="refresh-btn" onclick="loadData()">üîÑ Refresh Data</button>
            
            <div class="search-container">
                <input type="text" id="search-input" placeholder="Search player name..." 
                       onkeyup="filterTable()" onfocus="this.select()">
                <button onclick="clearSearch()" class="clear-search-btn">‚úï Clear</button>
            </div>
        </div>

        <div id="loading">
            <div class="spinner"></div>
            <div>Loading data from Google Sheets...</div>
        </div>

        <div id="data-container"></div>

        <div class="legend">
            <div class="legend-section">
                <h4>Rank Colors (Column 1)</h4>
                <div class="legend-items">
                    <span class="legend-item">
                        <span class="legend-box rank-1-3-box"></span>
                        Rank 1-3
                    </span>
                    <span class="legend-item">
                        <span class="legend-box rank-4-10-box"></span>
                        Rank 4-10
                    </span>
                    <span class="legend-item">
                        <span class="legend-box rank-11-25-box"></span>
                        Rank 11-25
                    </span>
                    <span class="legend-item">
                        <span class="legend-box rank-26-50-box"></span>
                        Rank 26-50
                    </span>
                </div>
            </div>
            
            <div class="legend-section">
                <h4>DKP Colors (Columns 2-6)</h4>
                <div class="legend-items">
                    <span class="legend-item">
                        <span class="legend-box green-dkp-box"></span>
                        = DKP ‚â• 100%
                    </span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =========== CONFIGURATION ===========
        const SPREADSHEET_ID = '2PACX-1vQwfeeWy3I-HC8aKkwldxD54DdMh_yRDa9ryDbJDq-RdCQDb81hOYqU48MORrRtWUV7JkBFCcm2TY7s';
        const SHEET_GID = '0';
        
        const CUSTOM_HEADERS = [
            'Rank',
            'Player Name',
            'DKP',
            'Power',
            'KP DKP',  // This column checked for ‚â•100%
            'Deads DKP'
        ];

        const START_ROW = 2;
        const TARGET_COLUMNS = [1, 2, 4, 3, 5, 6];
        
        const KP_DKP_COLUMN = 4; // Index of KP DKP column
        // ======================================

        const SHEET_URL = `https://docs.google.com/spreadsheets/d/e/${SPREADSHEET_ID}/pub?gid=${SHEET_GID}&single=true&output=csv`;
        
        let allPlayerData = [];
        let filteredData = [];

        async function loadData() {
            try {
                document.getElementById('loading').style.display = 'flex';
                document.getElementById('data-container').innerHTML = '';
                const url = `${SHEET_URL}&t=${new Date().getTime()}`;
                const response = await fetch(url);
                const csvText = await response.text();
                const results = Papa.parse(csvText, { header: false, skipEmptyLines: true });
                
                allPlayerData = extractData(results.data);
                filteredData = [...allPlayerData];
                
                displayData(filteredData);
                updateCounters();
                
                const now = new Date();
                document.getElementById('last-update').textContent = now.toLocaleTimeString();
                
            } catch (error) {
                document.getElementById('data-container').innerHTML =
                    `<div class="error-box">
                        <strong>Error loading data:</strong><br>
                        ${error.message}<br>
                        Please ensure: 1) The sheet is published, 2) The GID is correct.
                    </div>`;
                console.error("Error:", error);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function extractData(allRows) {
            if (!allRows || allRows.length === 0) return [];
            const extractedData = [];
            for (let rowIndex = START_ROW; rowIndex < allRows.length; rowIndex++) {
                const row = allRows[rowIndex];
                const extractedRow = [];
                TARGET_COLUMNS.forEach(colIndex => {
                    extractedRow.push((colIndex < row.length) ? (row[colIndex] || '') : '');
                });
                extractedData.push(extractedRow);
            }
            return extractedData;
        }

        function hasHighDkp(row) {
            if (!row || row.length <= KP_DKP_COLUMN) return false;
            
            const kpDkpValue = row[KP_DKP_COLUMN];
            if (!kpDkpValue) return false;
            
            // Remove % sign and convert to number
            const cleanValue = kpDkpValue.toString()
                .replace('%', '')
                .replace(',', '.')
                .trim();
            
            const numericValue = parseFloat(cleanValue);
            
            // Return true if number is valid and ‚â• 100
            return !isNaN(numericValue) && numericValue >= 100;
        }

        function getRankColorClass(rankValue) {
            const rankNum = parseInt(rankValue);
            if (isNaN(rankNum)) return '';
            
            if (rankNum >= 1 && rankNum <= 3) return 'rank-1-3';
            if (rankNum >= 4 && rankNum <= 10) return 'rank-4-10';
            if (rankNum >= 11 && rankNum <= 25) return 'rank-11-25';
            if (rankNum >= 26 && rankNum <= 50) return 'rank-26-50';
            
            return '';
        }

        // =========== CALCULATOR FUNCTIONS ===========
function searchPlayerForCalc() {
    const playerName = document.getElementById('calc-name').value.trim();
    
    if (!playerName) {
        alert('Please enter a player name');
        return;
    }
    
    // Search for player in data
    const player = allPlayerData.find(row => 
        row[1]?.toLowerCase() === playerName.toLowerCase()
    );
    
    const resultsDiv = document.getElementById('calculator-results');
    const notFoundDiv = document.getElementById('calculator-not-found');
    const formulaDiv = document.getElementById('calc-formula');
    
    if (!player) {
        // Player not found
        resultsDiv.style.display = 'none';
        notFoundDiv.style.display = 'block';
        formulaDiv.style.display = 'none';
        return;
    }
    
    // Player found - extract data
    // Index mapping: [0]Rank, [1]Name, [2]DKP, [3]Power, [4]KP DKP, [5]Deads DKP
    
    // Extract numeric values (remove commas, etc.)
    const powerStr = player[3]?.toString() || '0';
    const dkpStr = player[2]?.toString() || '0';
    const kpDkpStr = player[4]?.toString() || '0%';
    
    // Parse numbers
    const power = parseFloat(powerStr.replace(/[^0-9.-]/g, '')) || 0;
    const dkp = parseFloat(dkpStr.replace(/[^0-9.-]/g, '')) || 0;
    const kpDkp = parseFloat(kpDkpStr.replace(/[^0-9.-]/g, '')) || 0;
    
    // Calculate KP needed: (Power - DKP) * 2
    const kpNeeded = (power - dkp) * 2;
    
    // Calculate T4 and T5 kills
    const t4Kills = Math.ceil(kpNeeded / 10);
    const t5Kills = Math.ceil(kpNeeded / 20);
    
    // Format for display
    const formattedPower = power.toLocaleString('en-US');
    const formattedDkp = dkp.toLocaleString('en-US');
    const formattedKpNeeded = Math.round(kpNeeded).toLocaleString('en-US');
    const formattedT4Kills = t4Kills.toLocaleString('en-US');
    const formattedT5Kills = t5Kills.toLocaleString('en-US');
    
    // Update results
    document.getElementById('calc-power').textContent = formattedPower;
    document.getElementById('calc-dkp').textContent = formattedDkp;
    document.getElementById('calc-kp-needed').textContent = formattedKpNeeded;
    document.getElementById('calc-t4-kills').textContent = formattedT4Kills;
    document.getElementById('calc-t5-kills').textContent = formattedT5Kills;
    
    // Show results
    resultsDiv.style.display = 'block';
    notFoundDiv.style.display = 'none';
    formulaDiv.style.display = 'block';
    
    // Highlight if already at 100%+
    if (kpDkp >= 100) {
        document.getElementById('calc-kp-needed').innerHTML = '‚úÖ Already at 100%+';
        document.getElementById('calc-t4-kills').innerHTML = '‚úÖ';
        document.getElementById('calc-t5-kills').innerHTML = '‚úÖ';
    }
}

        function displayData(data) {
            if (!data || data.length === 0) {
                const searchTerm = document.getElementById('search-input').value;
                if (searchTerm) {
                    document.getElementById('data-container').innerHTML =
                        `<div class="no-data">No players found matching "${searchTerm}"</div>`;
                } else {
                    document.getElementById('data-container').innerHTML =
                        '<div class="no-data">No data available.</div>';
                }
                return;
            }
            
            let html = `<div class="table-container"><table><thead><tr>`;
            CUSTOM_HEADERS.forEach(header => { html += `<th>${header}</th>`; });
            html += `</tr></thead><tbody>`;
            
            data.forEach((row, rowIndex) => {
                const highDkp = hasHighDkp(row);
                
                html += `<tr>`;
                
                row.forEach((cell, cellIndex) => {
                    let cellContent = cell || '';
                    let cellClass = '';
                    
                    // Column 1: Rank-based colors
                    if (cellIndex === 0) {
                        cellClass = getRankColorClass(cellContent);
                        if (cellContent === '1') cellContent = 'ü•á ' + cellContent;
                        else if (cellContent === '2') cellContent = 'ü•à ' + cellContent;
                        else if (cellContent === '3') cellContent = 'ü•â ' + cellContent;
                    }
                    // Columns 2-6: Green if DKP ‚â• 100%
                    else if (cellIndex >= 1 && cellIndex <= 5 && highDkp) {
                        cellClass = 'green-dkp-cell';
                    }
                    
                    // Highlight search term in Player Name
                    const searchTerm = document.getElementById('search-input').value.toLowerCase();
                    if (cellIndex === 1 && searchTerm && cellContent.toLowerCase().includes(searchTerm)) {
                        const regex = new RegExp(`(${searchTerm})`, 'gi');
                        cellContent = cellContent.replace(regex, '<mark>$1</mark>');
                    }
                    
                    html += `<td class="${cellClass}">${cellContent}</td>`;
                });
                html += `</tr>`;
            });
            
            html += `</tbody></table></div>`;
            document.getElementById('data-container').innerHTML = html;
        }

        function filterTable() {
            const searchInput = document.getElementById('search-input');
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (!searchTerm) {
                filteredData = [...allPlayerData];
            } else {
                filteredData = allPlayerData.filter(row => {
                    const playerName = row[1] || '';
                    return playerName.toLowerCase().includes(searchTerm);
                });
            }
            
            displayData(filteredData);
            updateCounters();
        }

        function clearSearch() {
            document.getElementById('search-input').value = '';
            filteredData = [...allPlayerData];
            displayData(filteredData);
            updateCounters();
            document.getElementById('search-input').focus();
        }

        function updateCounters() {
            document.getElementById('player-count').textContent = allPlayerData.length;
            document.getElementById('showing-count').textContent = filteredData.length;
        }

        document.addEventListener('DOMContentLoaded', loadData);
        setInterval(loadData, 5 * 60 * 1000);
    </script>
</body>
</html>