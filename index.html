<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kingdom 3782 - DKP</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>üèÜ DKP - CH25</h1>

        <!-- =========== DKP CALCULATOR =========== -->
<div class="calculator">
    <h2>üßÆ DKP Calculator</h2>
    <p class="calculator-note">Enter your in-game name to see how much KP you need for 100% DKP</p>
    
    <div class="calculator-row">
        <div class="calculator-input-group">
            <label for="calc-name">Player Name:</label>
            <input type="text" id="calc-name" placeholder="Enter your nickname...">
        </div>
        <button class="calculator-btn" onclick="searchPlayerForCalc()">üîç Calculate</button>
    </div>
    
    <div id="calculator-results" class="calculator-results" style="display: none;">
        <div class="results-grid">
            <div class="result-item">
                <span class="result-label">Current Power:</span>
                <span class="result-value" id="calc-power">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">Current DKP:</span>
                <span class="result-value" id="calc-dkp">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">Current KP DKP:</span>
                <span class="result-value" id="calc-kp-dkp">-</span>
            </div>
            <div class="result-item highlight">
                <span class="result-label">T4/T5 KP needed for 100%:</span>
                <span class="result-value" id="calc-kp-needed">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">T4 units to kill (5 DKP/10 KP each):</span>
                <span class="result-value" id="calc-t4-kills">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">T5 units to kill (10 DKP/20 KP each):</span>
                <span class="result-value" id="calc-t5-kills">-</span>
            </div>
            <!-- NOWE POLA: ≈ömierci T4 i T5 -->
            <div class="result-item">
                <span class="result-label">T4 deaths needed (15 DKP each):</span>
                <span class="result-value" id="calc-t4-deaths">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">T5 deaths needed (20 DKP each):</span>
                <span class="result-value" id="calc-t5-deaths">-</span>
            </div>
        </div>
        <div class="calculation-formula" id="calc-formula" style="display: none;">
            Formula: (Power - DKP Points) √ó 2 = KP needed<br>
            T4 kills = KP needed √∑ 5 | T5 kills = KP needed √∑ 10<br>
            T4 deaths = KP needed √∑ 15 | T5 deaths = KP needed √∑ 20
        </div>
    </div>
    
    <div id="calculator-not-found" class="calculator-not-found" style="display: none;">
        ‚ùå Player not found. Check the spelling or try a different name.
    </div>
</div>

        <div class="stats">
            <div>Last Updated: <span id="last-update">-</span></div>
            <div>Total Players: <span id="player-count">0</span></div>
            <div>Showing: <span id="showing-count">0</span> players</div>
            <div>Last Scan: <span id="last-scan">21.02.2026</span></div>
        </div>

        <div class="controls">
            <button class="refresh-btn" onclick="loadData()">üîÑ Refresh Data</button>
            
            <div class="search-container">
                <input type="text" id="search-input" placeholder="Search player name..." 
                       onkeyup="filterTable()" onfocus="this.select()">
                <button onclick="clearSearch()" class="clear-search-btn">‚úï Clear</button>
            </div>
        </div>

        <div id="loading">
            <div class="spinner"></div>
            <div>Loading data from Google Sheets...</div>
        </div>

        <div id="data-container"></div>

        <div class="legend">
            <div class="legend-section">
                <h4>Rank Colors (Column 1)</h4>
                <div class="legend-items">
                    <span class="legend-item">
                        <span class="legend-box rank-1-3-box"></span>
                        Rank 1-3
                    </span>
                    <span class="legend-item">
                        <span class="legend-box rank-4-10-box"></span>
                        Rank 4-10
                    </span>
                    <span class="legend-item">
                        <span class="legend-box rank-11-25-box"></span>
                        Rank 11-25
                    </span>
                    <span class="legend-item">
                        <span class="legend-box rank-26-50-box"></span>
                        Rank 26-50
                    </span>
                </div>
            </div>
            
            <div class="legend-section">
                <h4>DKP Colors (Columns 2-6)</h4>
                <div class="legend-items">
                    <span class="legend-item">
                        <span class="legend-box green-dkp-box"></span>
                        = DKP ‚â• 100%
                    </span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =========== CONFIGURATION ===========
        const SPREADSHEET_ID = '2PACX-1vQwfeeWy3I-HC8aKkwldxD54DdMh_yRDa9ryDbJDq-RdCQDb81hOYqU48MORrRtWUV7JkBFCcm2TY7s';
        const SHEET_GID = '0';
        
        const CUSTOM_HEADERS = [
            'Rank',
            'Player Name',
            'DKP',
            'Power',
            'KP DKP',
            'Deads DKP'
        ];

        const START_ROW = 2;
        // Wczytujemy 7 kolumn z arkusza (B-H): B,C,E,D,F,G,H
        const TARGET_COLUMNS = [1, 2, 4, 3, 5, 6, 7];
        
        // Indeksy w tablicy allPlayerData
        const COL_RANK = 0;        // z kolumny B
        const COL_NAME = 1;         // z kolumny C  
        const COL_DKP = 2;          // z kolumny E (%)
        const COL_POWER = 3;        // z kolumny D (liczba)
        const COL_KP_DKP = 4;       // z kolumny F (%)
        const COL_DEADS_DKP = 5;    // z kolumny G (%)
        const COL_PUNKTY_DKP = 6;   // z kolumny H (liczba) - tylko do kalkulatora!
        
        // Alias dla czytelno≈õci
        const DKP_COLUMN = COL_DKP;
        // ======================================

        const SHEET_URL = `https://docs.google.com/spreadsheets/d/e/${SPREADSHEET_ID}/pub?gid=${SHEET_GID}&single=true&output=csv`;
        
        let allPlayerData = [];
        let filteredData = [];

        async function loadData() {
            try {
                document.getElementById('loading').style.display = 'flex';
                document.getElementById('data-container').innerHTML = '';
                const url = `${SHEET_URL}&t=${new Date().getTime()}`;
                const response = await fetch(url);
                const csvText = await response.text();
                const results = Papa.parse(csvText, { header: false, skipEmptyLines: true });
                
                allPlayerData = extractData(results.data);
                filteredData = [...allPlayerData];
                
                displayData(filteredData);
                updateCounters();
                
                const now = new Date();
                document.getElementById('last-update').textContent = now.toLocaleTimeString();
                
            } catch (error) {
                document.getElementById('data-container').innerHTML =
                    `<div class="error-box">
                        <strong>Error loading data:</strong><br>
                        ${error.message}<br>
                        Please ensure: 1) The sheet is published, 2) The GID is correct.
                    </div>`;
                console.error("Error:", error);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function extractData(allRows) {
            if (!allRows || allRows.length === 0) return [];
            const extractedData = [];
            for (let rowIndex = START_ROW; rowIndex < allRows.length; rowIndex++) {
                const row = allRows[rowIndex];
                const extractedRow = [];
                TARGET_COLUMNS.forEach(colIndex => {
                    extractedRow.push((colIndex < row.length) ? (row[colIndex] || '') : '');
                });
                // Tylko dodajemy je≈õli mamy nazwƒô gracza
                if (extractedRow[COL_NAME] && extractedRow[COL_NAME].trim() !== '') {
                    extractedData.push(extractedRow);
                }
            }
            return extractedData;
        }

        function parsePercentageValue(value) {
            if (!value) return 0;
            const clean = value.toString()
                .replace('%', '')
                .replace(',', '.')
                .trim();
            const num = parseFloat(clean);
            return isNaN(num) ? 0 : num;
        }

        function parseNumber(value) {
            if (!value) return 0;
            const clean = value.toString().replace(/[^0-9.-]/g, '');
            const num = parseFloat(clean);
            return isNaN(num) ? 0 : num;
        }

        function formatPercentage(num) {
            if (num === 0) return '0%';
            return num.toFixed(2) + '%';
        }

        function hasHighDkp(row) {
            if (!row || row.length <= DKP_COLUMN) return false;
            
            const dkpValue = row[DKP_COLUMN];
            if (!dkpValue) return false;
            
            const numericValue = parsePercentageValue(dkpValue);
            return !isNaN(numericValue) && numericValue >= 100;
        }

        function getRankColorClass(rankValue) {
            const rankNum = parseInt(rankValue);
            if (isNaN(rankNum)) return '';
            
            if (rankNum >= 1 && rankNum <= 3) return 'rank-1-3';
            if (rankNum >= 4 && rankNum <= 10) return 'rank-4-10';
            if (rankNum >= 11 && rankNum <= 25) return 'rank-11-25';
            if (rankNum >= 26 && rankNum <= 50) return 'rank-26-50';
            
            return '';
        }

        // =========== CALCULATOR FUNCTIONS ===========
        function searchPlayerForCalc() {
            const playerName = document.getElementById('calc-name').value.trim();
            
            if (!playerName) {
                alert('Please enter a player name');
                return;
            }
            
            const resultsDiv = document.getElementById('calculator-results');
            const notFoundDiv = document.getElementById('calculator-not-found');
            const formulaDiv = document.getElementById('calc-formula');
            
            if (!resultsDiv || !notFoundDiv || !formulaDiv) {
                console.error('Brakuje element√≥w kalkulatora w HTML!');
                return;
            }
            
            // Search for player in data (case insensitive)
            const player = allPlayerData.find(row => 
                row[COL_NAME]?.toLowerCase().trim() === playerName.toLowerCase()
            );
            
            if (!player) {
                resultsDiv.style.display = 'none';
                notFoundDiv.style.display = 'block';
                formulaDiv.style.display = 'none';
                return;
            }
            
            // Player found - extract data using named constants
            const powerStr = player[COL_POWER]?.toString() || '0';
            const punktyDKPStr = player[COL_PUNKTY_DKP]?.toString() || '0';
            const dkpProcent = player[COL_DKP]?.toString() || '0%';
            const kpDkpProcent = player[COL_KP_DKP]?.toString() || '0%';
            
            // Parse numbers
            const power = parseNumber(powerStr);
            const punktyDKP = parseNumber(punktyDKPStr);
            const dkp = parsePercentageValue(dkpProcent);
            const kpDkp = parsePercentageValue(kpDkpProcent);
            
            // Oblicz ile KP potrzeba do 100% DKP
            // Wz√≥r: (Power - PunktyDKP) √ó 2 = KP needed
            const kpNeeded = (power - punktyDKP) * 2;
            
            // Czy ju≈º osiƒÖgniƒôto 100% DKP?
            const isAtTarget = dkp >= 100;
            
            // Warto≈õƒá bezwzglƒôdna dla T4/T5 (je≈õli ju≈º po celu)
            const absoluteKpNeeded = Math.abs(kpNeeded);
            
            // Calculate T4 and T5 kills
            const t4Kills = Math.ceil(absoluteKpNeeded / 10);
            const t5Kills = Math.ceil(absoluteKpNeeded / 20);
            
            // Calculate T4 and T5 deaths (NEW)
            const t4Deaths = Math.ceil(absoluteKpNeeded / 30);
            const t5Deaths = Math.ceil(absoluteKpNeeded / 40); // T5 deaths te≈º 20 pkt
            
            // Format for display
            const formattedPower = power.toLocaleString('en-US');
            const formattedDkp = dkp.toFixed(2) + '%';
            const formattedKpDkp = kpDkp.toFixed(2) + '%';
            const formattedKpNeeded = Math.round(absoluteKpNeeded).toLocaleString('en-US');
            const formattedT4Kills = t4Kills.toLocaleString('en-US');
            const formattedT5Kills = t5Kills.toLocaleString('en-US');
            const formattedT4Deaths = t4Deaths.toLocaleString('en-US');
            const formattedT5Deaths = t5Deaths.toLocaleString('en-US');
            
            // Update results
            const powerEl = document.getElementById('calc-power');
            const dkpEl = document.getElementById('calc-dkp');
            const kpDkpEl = document.getElementById('calc-kp-dkp');
            const kpNeededEl = document.getElementById('calc-kp-needed');
            const t4KillsEl = document.getElementById('calc-t4-kills');
            const t5KillsEl = document.getElementById('calc-t5-kills');
            const t4DeathsEl = document.getElementById('calc-t4-deaths');
            const t5DeathsEl = document.getElementById('calc-t5-deaths');
            
            if (powerEl) powerEl.textContent = formattedPower;
            if (dkpEl) dkpEl.textContent = formattedDkp;
            if (kpDkpEl) kpDkpEl.textContent = formattedKpDkp;
            
            if (isAtTarget) {
                // Ju≈º ma 100% DKP
                if (kpNeededEl) kpNeededEl.innerHTML = '‚úÖ Already at 100% DKP!';
                if (t4KillsEl) t4KillsEl.innerHTML = '‚úÖ';
                if (t5KillsEl) t5KillsEl.innerHTML = '‚úÖ';
                if (t4DeathsEl) t4DeathsEl.innerHTML = '‚úÖ';
                if (t5DeathsEl) t5DeathsEl.innerHTML = '‚úÖ';
            } else {
                // Wy≈õwietl ile potrzeba do celu
                if (kpNeededEl) kpNeededEl.textContent = formattedKpNeeded;
                if (t4KillsEl) t4KillsEl.textContent = formattedT4Kills;
                if (t5KillsEl) t5KillsEl.textContent = formattedT5Kills;
                if (t4DeathsEl) t4DeathsEl.textContent = formattedT4Deaths;
                if (t5DeathsEl) t5DeathsEl.textContent = formattedT5Deaths;
            }
            
            // Show results
            resultsDiv.style.display = 'block';
            notFoundDiv.style.display = 'none';
            formulaDiv.style.display = 'block';
        }

        function displayData(data) {
            if (!data || data.length === 0) {
                const searchTerm = document.getElementById('search-input').value;
                if (searchTerm) {
                    document.getElementById('data-container').innerHTML =
                        `<div class="no-data">No players found matching "${searchTerm}"</div>`;
                } else {
                    document.getElementById('data-container').innerHTML =
                        '<div class="no-data">No data available.</div>';
                }
                return;
            }
            
            let html = `<div class="table-container"><table><thead><tr>`;
            // Wy≈õwietlamy tylko 6 nag≈Ç√≥wk√≥w
            CUSTOM_HEADERS.forEach(header => { html += `<th>${header}</th>`; });
            html += `</tr></thead><tbody>`;
            
            data.forEach((row, rowIndex) => {
                const highDkp = hasHighDkp(row);
                
                html += `<tr>`;
                
                // Wy≈õwietlamy tylko pierwsze 6 kolumn (pomijamy COL_PUNKTY_DKP)
                for (let cellIndex = 0; cellIndex < 6; cellIndex++) {
                    let cellContent = row[cellIndex] || '';
                    let cellClass = '';
                    
                    // Column 1: Rank-based colors
                    if (cellIndex === COL_RANK) {
                        cellClass = getRankColorClass(cellContent);
                        if (cellContent === '1') cellContent = 'ü•á ' + cellContent;
                        else if (cellContent === '2') cellContent = 'ü•à ' + cellContent;
                        else if (cellContent === '3') cellContent = 'ü•â ' + cellContent;
                    }
                    // Columns 2-6: Green if DKP ‚â• 100%
                    else if (cellIndex >= 1 && cellIndex <= 5 && highDkp) {
                        cellClass = 'green-dkp-cell';
                    }
                    
                    // Highlight search term in Player Name
                    const searchTerm = document.getElementById('search-input').value.toLowerCase();
                    if (cellIndex === COL_NAME && searchTerm && cellContent.toLowerCase().includes(searchTerm)) {
                        const regex = new RegExp(`(${searchTerm})`, 'gi');
                        cellContent = cellContent.replace(regex, '<mark>$1</mark>');
                    }
                    
                    html += `<td class="${cellClass}">${cellContent}</td>`;
                }
                html += `</tr>`;
            });
            
            html += `</tbody></table></div>`;
            document.getElementById('data-container').innerHTML = html;
        }

        function filterTable() {
            const searchInput = document.getElementById('search-input');
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (!searchTerm) {
                filteredData = [...allPlayerData];
            } else {
                filteredData = allPlayerData.filter(row => {
                    const playerName = row[COL_NAME] || '';
                    return playerName.toLowerCase().includes(searchTerm);
                });
            }
            
            displayData(filteredData);
            updateCounters();
        }

        function clearSearch() {
            document.getElementById('search-input').value = '';
            filteredData = [...allPlayerData];
            displayData(filteredData);
            updateCounters();
            document.getElementById('search-input').focus();
        }

        function updateCounters() {
            document.getElementById('player-count').textContent = allPlayerData.length;
            document.getElementById('showing-count').textContent = filteredData.length;
        }

        document.addEventListener('DOMContentLoaded', loadData);
        setInterval(loadData, 5 * 60 * 1000);
    </script>
</body>
</html>